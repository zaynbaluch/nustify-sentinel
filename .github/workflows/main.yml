name: Daily Admissions Scan

on:
  schedule:
    - cron: '20 20 * * *'  # 1:20 AM PKT
  workflow_dispatch:

jobs:
  scan:
    runs-on: ubuntu-latest
    environment: .env
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium

      # üîç DEBUG STEP (TEMPORARY)
      - name: Debug secret injection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        run: |
          echo "==== SECRET INJECTION CHECK ===="

          [ -z "$SUPABASE_URL" ] && echo "SUPABASE_URL ‚ùå MISSING" || echo "SUPABASE_URL ‚úÖ PRESENT"
          [ -z "$SUPABASE_KEY" ] && echo "SUPABASE_KEY ‚ùå MISSING" || echo "SUPABASE_KEY ‚úÖ PRESENT"
          [ -z "$GEMINI_API_KEY" ] && echo "GEMINI_API_KEY ‚ùå MISSING" || echo "GEMINI_API_KEY ‚úÖ PRESENT"
          [ -z "$SMTP_SERVER" ] && echo "SMTP_SERVER ‚ùå MISSING" || echo "SMTP_SERVER ‚úÖ PRESENT"
          [ -z "$SMTP_PORT" ] && echo "SMTP_PORT ‚ùå MISSING" || echo "SMTP_PORT ‚úÖ PRESENT"
          [ -z "$SENDER_EMAIL" ] && echo "SENDER_EMAIL ‚ùå MISSING" || echo "SENDER_EMAIL ‚úÖ PRESENT"
          [ -z "$SENDER_PASSWORD" ] && echo "SENDER_PASSWORD ‚ùå MISSING" || echo "SENDER_PASSWORD ‚úÖ PRESENT"

          echo "================================"

      # üöÄ ACTUAL JOB
      - name: Run worker
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SMTP_SERVER: ${{ secrets.SMTP_SERVER }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        run: python worker.py